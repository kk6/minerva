# Minerva 開発ワークフロー

このドキュメントでは、Minervaプロジェクトの開発ワークフローとベストプラクティスについて説明します。

## 1. 開発環境のセットアップ

### 1.1 必要な環境

- Python 3.10以上
- uv（依存関係管理）
- Git

### 1.2 リポジトリのクローンと依存関係のインストール

```bash
# リポジトリのクローン
git clone https://github.com/yourorg/minerva.git
cd minerva

# 依存関係のインストール
uv pip install -e .
```

### 1.3 開発用仮想環境の作成と有効化

```bash
# 新しい仮想環境の作成
uv venv

# 仮想環境の有効化
# Linuxやmacの場合
source .venv/bin/activate
# Windowsの場合
# .venv\Scripts\activate

# 開発用依存関係のインストール
uv pip install -e ".[dev]"
```

### 1.4 .envファイルとPYTHONPATHの設定

本プロジェクトでは、`minerva` モジュールを正しくimportできるようにするため、`.env` ファイルに `PYTHONPATH=src` を追加しています。
これにより、`uv run pytest` などのコマンド実行時に毎回 `PYTHONPATH=src` を指定する必要がありません。

すでに `.env.example` に `PYTHONPATH=src` が記載されているので、`.env` ファイルを作成する際はこの内容をコピーしてください。

## 2. ブランチ戦略

Minervaプロジェクトでは、以下のブランチ戦略を採用しています：

### 2.1 ブランチ種別

- `main`: 安定版のコード、本番環境にデプロイ可能な状態
- `develop`: 開発ブランチ、次のリリース向けの変更を統合
- `feature/<機能名>`: 新機能の開発
- `bugfix/<バグID>`: バグ修正
- `release/<バージョン>`: リリース準備
- `hotfix/<バグID>`: 緊急のバグ修正（本番環境用）

### 2.2 ブランチワークフロー

1. `develop`ブランチから`feature/<機能名>`ブランチを作成
2. 機能開発を実施
3. テストの作成と実行（コードカバレッジの確認）
4. プルリクエストを作成し、コードレビューを依頼
5. レビュー後、`develop`ブランチにマージ
6. リリース準備時に`release/<バージョン>`ブランチを作成
7. リリーステストとドキュメント更新を実施
8. テスト完了後、`main`ブランチと`develop`ブランチにマージ

## 3. 開発サイクル

### 3.1 新機能の開発

新機能を開発する際のワークフローです：

1. 仕様の確認とタスクの分解
2. テスト駆動開発（TDD）の実践：
   - 失敗するテストを作成
   - 最小限のコードで実装
   - テストが通ることを確認
   - リファクタリング
3. AAAパターンに従ったテストの作成・改善
4. ドキュメントの更新
5. コードレビューの依頼

### 3.2 バグ修正

バグを修正する際のワークフローです：

1. バグの再現と問題の特定
2. バグを再現するテストケースの作成
3. バグ修正の実装
4. テストの実行と確認
5. 関連するドキュメントの更新
6. コードレビューの依頼

## 4. コーディング規約

### 4.1 PEP 8

Pythonの公式スタイルガイドであるPEP 8に準拠します。主な規約は以下の通りです：

- インデントは4スペース
- 行の最大長は88文字（Ruff準拠）
- クラス名はCamelCase
- 関数名とメソッド名はsnake_case
- 定数はALL_CAPS
- インポートは標準ライブラリ、サードパーティ、ローカルの順に分類

### 4.2 コードフォーマッタとリンター

Ruffを使用して、コードの品質と一貫性を確保します。Ruffは高速なPythonリンター兼フォーマッタで、以前のBlack、isort、Flake8などの機能を統合したツールです。

全てのPRは、Ruffによるチェックを通過する必要があります。

```bash
# Ruffでのコード形式チェックと問題の表示
uv run ruff check minerva tests

# Ruffでのコード自動フォーマット（インポート整理を含む）
uv run ruff format minerva tests

# 型チェックの実行
uv run mypy minerva
```

## 5. コードレビュープロセス

### 5.1 プルリクエスト（PR）の作成

PRには以下の情報を含めてください：

- タイトル：変更内容を簡潔に表現
- 説明：
  - 変更の背景と目的
  - 実装の概要
  - テスト方法
  - 注意点やレビュアーに確認して欲しい点

### 5.2 レビュー基準

コードレビューでは以下の点を確認します：

- 機能要件を満たしているか
- コーディング規約に準拠しているか
- テストが十分かつ適切に書かれているか
- エラー処理が適切か
- パフォーマンスに問題はないか
- セキュリティリスクはないか
- ドキュメントが更新されているか

### 5.3 レビューコメントへの対応

- 全てのコメントに対応する
- 議論が必要な場合はスレッドで続ける
- 対応完了後はレビュアーに再レビューを依頼

## 6. リリースプロセス

### 6.1 バージョニング

セマンティックバージョニング（SemVer）を採用します：

- メジャーバージョン（X.0.0）：後方互換性のない変更
- マイナーバージョン（0.X.0）：後方互換性のある機能追加
- パッチバージョン（0.0.X）：バグ修正

### 6.2 リリース手順

1. `release/<バージョン>`ブランチの作成
2. バージョン番号とCHANGELOGの更新
3. リリーステストの実行
4. ドキュメントの最終確認
5. `main`ブランチへのマージ
6. タグの作成
7. パッケージのビルドと公開（uvを使用）
   ```bash
   # ビルド
   uv pip build
   
   # 公開
   uv pip publish
   ```
8. `develop`ブランチへのマージ

## 7. ドキュメント管理

### 7.1 ドキュメントの種類

- READMEとセットアップガイド
- 機能仕様書
- 技術仕様書
- テストガイドライン
- APIドキュメント
- ユーザーガイド

### 7.2 ドキュメント更新のタイミング

- 新機能の追加時
- 既存機能の変更時
- バグ修正による動作変更時
- リリース前の最終確認時

### 7.3 ドキュメント形式

ドキュメントはMarkdown形式で記述し、`docs/`ディレクトリで管理します：

- `docs/note_operations.md` - ノート操作機能仕様書
- `docs/technical_spec.md` - 技術仕様書
- `docs/test_guidelines.md` - テストガイドライン
- `docs/development_workflow.md` - 開発ワークフロー（本ドキュメント）

## 8. 継続的インテグレーションと継続的デリバリー（CI/CD）

### 8.1 CI/CDパイプライン

GitHub Actionsを使用して以下のパイプラインを構築しています：

1. コードの品質チェック
   - コードフォーマットの検証
   - リンターの実行
   - 型チェック
2. テストの実行
   - 単体テスト
   - 統合テスト
   - カバレッジレポートの生成
3. ビルドとパッケージング
4. デプロイ（本番環境への反映）

### 8.2 自動化されたタスク

- プルリクエスト時の自動テスト
- Ruffによるコード品質チェック
- コードカバレッジレポートの自動生成
  ```bash
  # カバレッジを測定してHTMLレポートを生成
  uv run pytest --cov=minerva --cov-report=html
  ```
- ドキュメントの自動生成と公開
- リリース時のパッケージ自動公開

## 9. 問題解決とサポート

### 9.1 問題報告

バグや改善要望は、以下の情報を含めてIssueとして登録してください：

- 問題の概要
- 再現手順
- 期待される動作
- 実際の動作
- 環境情報（OSやPythonのバージョンなど）
- スクリーンショットや参考情報（可能であれば）

### 9.2 サポートチャンネル

- GitHub Issues：バグ報告と機能リクエスト
- Slack：チーム内のコミュニケーション
- ドキュメント：自己解決のための情報源

## 10. 開発のベストプラクティス

- シンプルで読みやすいコードを書く
- 適切な抽象化レベルを保つ
- DRY原則（Don't Repeat Yourself）を守る
- SOLID原則に従う
- 小さくて焦点を絞ったPRを作成する
- テスト駆動開発を実践する
- コードよりもドキュメントを先に更新する
- 定期的にコードレビューを行う

### 10.1 依存関係管理のベストプラクティス

#### 10.1.1 開発環境と実行環境の分離理解

Minervaプロジェクトでは、2つの環境で依存関係を管理する必要があります：

1. **プロジェクトの開発環境**：
   - `pyproject.toml`と`uv.lock`で管理される環境
   - 開発、テスト実行、CI/CD環境で使用される

2. **Claude Desktop実行環境**：
   - `claude_desktop_config.json`の`--with`オプションで指定される一時的な環境
   - サーバー実行時のみ使用され、実行後に破棄される

#### 10.1.2 依存関係変更時のチェックリスト

新しい依存関係を追加する際のチェックリストです：

1. `pyproject.toml`の`dependencies`に依存関係を追加
2. `uv pip install -e .`を実行して開発環境に反映
3. `uv.lock`が更新されていることを確認
4. コードで正しいインポート名を使用していることを確認
5. Claude Desktop設定ファイルの`--with`オプションにも同じパッケージを追加
6. VSCode/Claude Desktopを再起動してサーバーが正常に起動することを確認

#### 10.1.3 パッケージ名とインポート名の違いに注意

パッケージによっては、インストール時の名前（PyPIパッケージ名）とPythonでインポートする際の名前が異なる場合があります：

| インストール名 (PyPI) | インポート名 (Python) | 例 |
|-----------------|----------------|-----------|
| python-frontmatter | frontmatter | `import frontmatter` |
| python-dotenv | dotenv | `import dotenv` |

このような違いがある場合は、両方のドキュメントで明確に記述しましょう。

これらのガイドラインに従うことで、Minervaプロジェクトの開発効率と品質を高めていきましょう。
