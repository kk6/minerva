# Minerva 要件定義書

## 1. プロジェクト概要

### 1.1 背景と目的

Minervaは、Claude Desktopと連携し、Obsidianのナレッジベース（Vault）内のMarkdownファイルを効率的に管理・操作するためのツールです。本ツールにより、AIアシスタントとのチャットからMarkdownドキュメントの作成、検索、閲覧を自動化し、ナレッジ管理の効率を向上させることを目的としています。

### 1.2 ターゲットユーザー

- Obsidianをナレッジベースとして使用しているユーザー
- Claude Desktopを活用したい開発者や知識労働者
- AIと連携した文書管理の自動化を求めるユーザー

### 1.3 システム概要

Minervaは、Claude Desktop（MCPプラットフォーム）上で動作するツールとして実装されます。ユーザーはClaudeとのチャットインターフェースを通じて、ナレッジベース内のMarkdownファイルの操作（作成、読取、検索）を行うことができます。

## 2. 機能要件

### 2.1 核となる機能

#### 2.1.1 ノートの作成（create_note）
- Claudeとのチャットから直接Markdownファイルを作成できる
- ファイル名とコンテンツを指定可能
- フロントマター（メタデータ）が自動的に追加される
- 既存ファイルの場合はエラーを返す

#### 2.1.2 ノートの編集（edit_note）
- 既存のMarkdownファイルの内容を更新できる
- フロントマターの作成日は維持し、更新日のみ変更される
- 存在しないファイルの場合はエラーを返す

#### 2.1.3 ノートの読取（read_note）
- 指定したMarkdownファイルの内容をClaudeチャット内で表示
- ファイルパスを指定して読み込み

#### 2.1.4 ノートの検索（search_notes）
- キーワードによるファイル検索機能
- 大文字小文字の区別設定オプションあり
- 検索結果にはファイルパス、該当行番号、コンテキスト情報を含む

#### 2.1.4.1 ベクター検索機能（Phase 1実装完了）
- **セマンティック検索**: 意味的類似性による検索機能
- **関連ノート発見**: 指定したノートと類似する内容のノートを発見

**Phase 1実装状況（完了）**:
- ✅ **インフラ構築**: `vector/`モジュール構造と抽象クラス設計
- ✅ **埋め込み生成**: SentenceTransformerProviderでall-MiniLM-L6-v2モデル実装
- ✅ **ベクターインデックス**: DuckDB VSS拡張でHNSWインデックス実装
- ✅ **設定管理**: オプション機能として環境変数で制御
- ✅ **テストインフラ**: 包括的な単体テストと統合テスト
- ✅ **オプショナル依存関係管理**: 適切なエラーメッセージとlazy loading

**Phase 2予定（開発中）**:
- 🚧 **検索API統合**: メイン検索機能へのベクター検索統合
- 🚧 **UI/UX最適化**: ユーザーインターフェースの整備
- 🚧 **パフォーマンスチューニング**: 大規模vault対応

**技術スタック**: DuckDB 1.1.3+, sentence-transformers 3.3.1+, numpy 1.24.0+ (オプション依存)

#### 2.1.5 ノートの削除（2段階プロセス）
- get_note_delete_confirmation：削除前の確認情報を取得
- perform_note_delete：確認後に実際の削除を実行
- 2段階プロセスにより誤削除を防止

### 2.2 タグ管理機能

#### 2.2.1 タグの追加（add_tag）
- 指定したノートに新しいタグを追加
- タグは正規化（小文字化、空白トリム）して処理
- 同一タグの重複追加を防止

#### 2.2.2 タグの削除（remove_tag）
- 指定したノートから特定のタグを削除
- タグが存在しない場合は何も起こらない
- 最後のタグを削除した場合、メタデータからtagsフィールド自体が削除される

#### 2.2.3 タグの名前変更（rename_tag）
- ディレクトリまたはvault全体の特定タグ名を一括変更
- 新しいタグ名が既存タグと衝突する場合はマージする

#### 2.2.4 タグの取得（get_tags）
- 特定ノートからすべてのタグを取得
- 元のケーシングを保持

#### 2.2.5 全タグのリスト取得（list_all_tags）
- ディレクトリまたはvault全体のユニークなタグをリスト化
- 正規化・アルファベット順でソート

#### 2.2.6 タグによるノート検索（find_notes_with_tag）
- 特定のタグを含むすべてのノートを検索
- 大文字小文字は区別せず正規化して比較

### 2.3 エイリアス管理機能

#### 2.3.1 エイリアスの追加（add_alias）
- 指定したノートに新しいエイリアス（別名）を追加
- エイリアスは大文字小文字を区別せず、重複を防止
- 既存のファイル名やエイリアスとの競合を検出・防止
- Obsidian互換の文字制限（|, #, ^, [, ]を禁止）

#### 2.3.2 エイリアスの削除（remove_alias）
- 指定したノートから特定のエイリアスを削除
- エイリアスが存在しない場合は何も起こらない
- 最後のエイリアスを削除した場合、メタデータからaliasesフィールド自体が削除される

#### 2.3.3 エイリアスの取得（get_aliases）
- 特定ノートからすべてのエイリアスを取得
- 元のケーシングを保持

#### 2.3.4 エイリアスによるノート検索（search_by_alias）
- 特定のエイリアスを含むすべてのノートを検索
- 大文字小文字は区別せず正規化して比較
- ディレクトリ指定により検索範囲を限定可能

### 2.4 追加機能（拡張性）

- 将来的にはObsidianのリンク構造を解析する機能の追加
- Front Matter 編集支援 - YAMLメタデータの構造を保った属性追加／変更
- バージョン履歴統合 - Git連携による変更履歴管理
- 一括リファクタリング - ファイル名変更やフォルダ移動時のリンク整合性維持
- 要約／抄録生成 - 長文ノートの要約を自動生成しfrontmatterに追加

## 3. 非機能要件

### 3.1 パフォーマンス要件

- 検索機能は大規模なVault（1000ファイル以上）でも1秒以内に結果を返す
- ファイル操作（読み書き）はユーザーの体感で遅延なく実行される
- **テストパフォーマンス**: 開発効率を高めるためのpytestマーカー実装
  - 高速テスト: 487テストを約5秒で実行（日常開発用）
  - 遅いテスト: 5テストを約17秒で実行（MLモデルテスト）
  - 85%の速度向上を達成

### 3.2 セキュリティ要件

- ローカルファイルシステムへのアクセスは指定されたVaultディレクトリ内に限定
- ファイル名にセキュリティリスク（パス・トラバーサルなど）となる文字を禁止
- バイナリファイルの誤読み込みを防止するための検出機能
- **オプショナル依存関係セキュリティ**: ベクター検索機能は環境変数で無効化可能

### 3.3 互換性要件

- Python 3.12以上での動作保証
- Obsidianの標準的なVault構造との互換性確保
- Claude Desktop/MCPフレームワークとの連携
- **ベクター検索依存関係**: DuckDB 1.1.3+, sentence-transformers 3.3.1+, numpy 1.24.0+（オプション）

### 3.4 保守性・拡張性要件

- モジュール分割による機能の疎結合化
- 明確なエラーハンドリングと詳細なログ出力
- テスト自動化によるコード品質の確保

## 4. 技術仕様

### 4.1 システムアーキテクチャ

```
Minerva
├── MCPサーバー (server.py) - FastMCP + @mcp.tool()デコレータ
│   ├── create_note
│   ├── edit_note
│   ├── read_note
│   ├── search_notes
│   ├── add_alias
│   ├── remove_alias
│   ├── get_aliases
│   └── search_by_alias
├── サービス層 (services/) - モジュール化されたビジネスロジック
│   ├── ServiceManager - 統一インターフェース（ファサード）
│   ├── NoteOperations - ノート操作サービス
│   ├── TagOperations - タグ管理サービス
│   ├── AliasOperations - エイリアス管理サービス
│   └── SearchOperations - 検索サービス
├── ファイル操作モジュール (file_handler.py)
└── 設定管理 (config.py)
```

### 4.2 技術スタック

- **言語**: Python 3.12以上
- **フレームワーク**: MCP (Claude Desktop連携用)
- **依存ライブラリ**:
  - mcp[cli] >= 1.9.3: Claude Desktopとの連携（MCP 1.9対応）
  - pydantic >= 2.11.3: データバリデーションと型チェック
  - python-dotenv >= 1.1.0: 環境変数の管理
- **開発・テスト用**:
  - pytest >= 8.3.5: 自動テスト
  - pytest-cov >= 6.1.1: コードカバレッジ確認

### 4.3 データモデル

#### 4.3.1 ファイル操作リクエスト

- `FileWriteRequest`: ファイル書き込み要求モデル
  - directory: 保存先ディレクトリパス
  - filename: ファイル名
  - content: ファイル内容
  - overwrite: 上書きフラグ

- `FileReadRequest`: ファイル読み込み要求モデル
  - directory: 読み込み元ディレクトリパス
  - filename: ファイル名

#### 4.3.2 検索関連

- `SearchConfig`: 検索設定モデル
  - directory: 検索対象ディレクトリ
  - keyword: 検索キーワード
  - case_sensitive: 大文字小文字区別フラグ
  - file_extensions: 検索対象ファイル拡張子リスト

- `SearchResult`: 検索結果モデル
  - file_path: ファイルパス
  - line_number: 検出行番号
  - context: 検出コンテキスト

## 5. 設定と環境

### 5.1 環境変数

#### 必須環境変数

- `OBSIDIAN_VAULT_ROOT`: Obsidianのvaultルートディレクトリのパス
- `DEFAULT_VAULT`: デフォルトで使用するvault名

#### オプション環境変数

- `MINERVA_SKIP_DOTENV`: `.env`ファイルの読み込みをスキップ（テスト環境やCI/CDで使用）
  - 設定値: `"1"` で有効化
  - 用途: テスト実行時の環境変数隔離、CI/CDパイプラインでの制御

### 5.2 セットアップ

1. 必要な環境変数を`.env`ファイルに設定
2. 依存パッケージのインストール: `uv` パッケージマネージャを使用
3. MCPサーバーの起動: `uv run mcp dev server.py`
4. Claude Desktopへのインストール: `uv run mcp install src/minerva/server.py:mcp -f .env --with-editable .`

### 5.3 依存関係の管理

#### 5.3.1 プロジェクト開発環境と実行環境の違い

Minervaプロジェクトでは、以下の2つの異なる環境での依存関係管理を理解する必要があります：

1. **プロジェクト開発環境**：
   - `pyproject.toml`と`uv.lock`で管理
   - 開発、テスト、CI/CD環境で使用
   - `uv pip install -e .`などで依存関係をインストール

2. **Claude Desktop実行環境**：
   - `/Users/<ユーザー名>/Library/Application Support/Claude/claude_desktop_config.json`で設定
   - `uv run --with`コマンドによる一時的な実行環境
   - 明示的に必要なパッケージをすべて指定する必要あり

重要: パッケージの**インストール名**（例: `python-frontmatter`）と**インポート名**（例: `import frontmatter`）が異なる場合があるため、両方の名前を正確に把握する必要があります。

## 6. テスト戦略

### 6.1 単体テスト

- 各ツール機能（create_note, edit_note, read_note, search_notes）の単体テスト
- ファイル操作関連の例外ハンドリングテスト
- バリデーション機能の確認テスト

### 6.2 統合テスト

- MCPサーバーとの連携テスト
- Claude Desktopからの呼び出しシミュレーション

### 6.3 テスト自動化

- pytestによるテスト自動化
- CI/CDパイプラインにおけるテスト実行の自動化
- カバレッジポリシー

#### カバレッジポリシー

- カバレッジレポート生成（目標: 90%以上、現状: 89%）
- CI/CDパイプラインにおけるテスト実行の自動化

### 6.4 コードカバレッジ

コードカバレッジについての詳細は、[4. コードカバレッジ](test_guidelines.md#4コードカバレッジ)を参照してください。

### 6.5 CI/CD要件

#### 6.5.1 継続的インテグレーション（CI）

- **コード品質チェック**
  - Ruff による構文チェックとコードフォーマット検証
  - MyPy による型チェック
  - プルリクエスト時の自動実行

- **テスト実行**
  - pytest による全テストの自動実行
  - Python 3.12, 3.13 のマトリックステスト対応
  - テスト失敗時のプルリクエストマージブロック

- **カバレッジ測定**
  - pytest-cov によるコードカバレッジ測定
  - HTML レポート生成とアーティファクト保存
  - カバレッジ結果の Codecov への自動アップロード

#### 6.5.2 継続的デリバリー（CD）

- **自動リリース**
  - semantic-release による semantic versioning 準拠の自動リリース
  - リリースノートの自動生成
  - PyPI への自動パッケージ公開（将来的な要件）

- **セキュリティ**
  - 依存関係の脆弱性チェック
  - Secrets の適切な管理

#### 6.5.3 ワークフロー要件

- **メインCIワークフロー**（`.github/workflows/ci.yml`）
  - プルリクエスト及び main ブランチ push 時実行
  - コード品質チェック、テスト実行、カバレッジ測定を並列実行
  - 高速な実行時間（目標: 5分以内）

- **プルリクエスト専用チェック**（`.github/workflows/pr-checks.yml`）
  - 軽量なクイックチェック
  - コミットメッセージ形式チェック
  - ドキュメント更新確認

- **既存リリースワークフローとの統合**
  - 現在の `.github/workflows/release.yml` との互換性維持
  - CI 成功後のリリース実行

## 7. 運用・保守

### 7.1 ログ記録

- ログレベルの適切な設定
- 主要操作のログ記録（ファイル作成、読取、検索）
- エラー時の詳細ログ出力

### 7.2 エラーハンドリング

- ファイル関連のエラー（存在しないファイル、上書き、権限エラーなど）
- 検索関連のエラー（無効なキーワード、大規模ファイルなど）
- ユーザーへわかりやすいエラーメッセージの提供

## 8. 制約事項

- バイナリファイルやObsidianの特殊構文の一部は正確に処理できない可能性あり
- 特定の文字（`<>:"\/|?*`）をファイル名に使用不可
- Python 3.12以上の環境が必要

## 9. 今後のロードマップ

- Obsidianの高度な機能（埋め込み、リンク、メタデータなど）のサポート
- 複数Vaultの同時操作機能
- ファイル内容の更新・差分管理機能
- テンプレート機能の追加

## 10. 使用例

### 10.1 基本的な使用例

```
# ファイル作成例
create_note 関数を使用して、先ほど作成したMarkdown文書を書き出します。

minerva(ローカル)からの create_note の結果を表示 >

Markdown文書を「web_development_best_practices.md」というファイル名で書き出しました。
```

### 10.2 高度な使用例

```
# 検索と内容読み取りの連携例
search_notes関数でキーワード「Python」を含むファイルを検索し、最も関連性の高いファイルをread_note関数で表示する。

# 構造化ドキュメントの作成例
Claudeとの対話で得た情報をcreate_note関数を使って新しいドキュメントとして保存し、または既存のドキュメントをedit_note関数で更新し、ナレッジベースを充実させる。
```

## 11. 用語集

- **MCP**: Model Control Protocol - Claude Desktopが使用するツール連携のためのプロトコル
- **Vault**: Obsidianにおけるローカルのナレッジベースディレクトリ
- **Claude Desktop**: Anthropic社のAIアシスタント「Claude」のデスクトップアプリケーション
